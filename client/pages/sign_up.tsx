import { NextPage } from 'next';
import Head from 'next/head';
import { createTheme, ThemeProvider } from '@mui/material/styles';
import axios from 'axios';
import {
  Grid,
  Typography,
  Box,
  Paper,
  Link,
  TextField,
  CssBaseline,
  Button,
} from '@mui/material';
import { FormEvent, useContext, useState } from 'react';
import { useRouter } from 'next/router';
import { AppContext } from './_app';
import { User } from '../lib/model/user';

function Copyright(props: any) {
  return (
    <Typography
      variant='body2'
      color='text.secondary'
      align='center'
      {...props}
    >
      {'Copyright © '}
      <Link color='inherit' href='https://mui.com/'>
        Your Website
      </Link>{' '}
      {new Date().getFullYear()}
      {'.'}
    </Typography>
  );
}

const SignUp: NextPage = () => {
  const { setUser } = useContext(AppContext);
  const theme = createTheme();
  const router = useRouter();
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  const onSubmit = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    try {
      const res = await axios.post('http://localhost:3000/sign_up', {
        name: name,
        email: email,
        password: password,
      });
      const token: string = res.data.token;
      localStorage.setItem('token', token);
      setUser(
        new User(
          res.data.user.id,
          res.data.user.name,
          res.data.user.email,
          res.data.user.password,
          new Date(res.data.user.created_at)
        )
      );
      router.push('/');
    } catch (e) {
      if (e instanceof Error) {
        alert(e.message);
      }
    }
  };

  return (
    <div>
      <Head>
        <title>ログイン</title>
        <meta name='description' content='Generated by create next app' />
        <link rel='icon' href='/favicon.ico' />
      </Head>

      <ThemeProvider theme={theme}>
        <Grid container component='main' sx={{ height: '100vh' }}>
          <CssBaseline />
          <Grid
            item
            xs={false}
            sm={4}
            md={7}
            sx={{
              backgroundImage: 'url(https://source.unsplash.com/random)',
              backgroundRepeat: 'no-repeat',
              backgroundColor: (t) =>
                t.palette.mode === 'light'
                  ? t.palette.grey[50]
                  : t.palette.grey[900],
              backgroundSize: 'cover',
              backgroundPosition: 'center',
            }}
          />
          <Grid
            item
            xs={12}
            sm={8}
            md={5}
            component={Paper}
            elevation={6}
            square
          >
            <Box
              sx={{
                my: 8,
                mx: 4,
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
              }}
            >
              <Typography component='h1' variant='h5'>
                Sign Up
              </Typography>
              <form onSubmit={onSubmit}>
                <TextField
                  margin='normal'
                  required
                  fullWidth
                  label='氏名'
                  name='name'
                  autoComplete='name'
                  autoFocus
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                />
                <TextField
                  margin='normal'
                  required
                  fullWidth
                  label='Email Address'
                  name='email'
                  autoComplete='email'
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                />
                <TextField
                  margin='normal'
                  required
                  fullWidth
                  name='password'
                  label='Password'
                  type='password'
                  autoComplete='current-password'
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                />
                <Button
                  type='submit'
                  fullWidth
                  variant='contained'
                  className='bg-blue-400'
                  sx={{ mt: 3, mb: 2 }}
                >
                  Sign Up
                </Button>
                <Button onClick={() => router.push('/login')}>
                  ログインに戻る
                </Button>
                <Copyright sx={{ mt: 5 }} />
              </form>
            </Box>
          </Grid>
        </Grid>
      </ThemeProvider>
    </div>
  );
};

export default SignUp;
